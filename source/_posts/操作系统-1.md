---
title: 操作系统-1
date: 2024-10-18 09:19:47
tags:
    - 学习笔记
---
## 概念和功能
### 操作系统的概念(定义)
**操作系统**(Operating System, OS)是指控制和管理整个计算机系统的**硬件和软件**资源，并合理的组织调度计算机的工作和资源分配；以**提供给用户和其他软件方便的接口和环境**；它是计算机系统中最基本的系统软件。
1. 操作系统是系统资源的管理者。
   执行一个程序前，需要将程序放入内存中，才能被CPU处理，而操作系统会对整个系统中的软硬件调用进行相应的管理。
2. 向上层提供方便易用的服务。
   对于硬件，一般只能识别二进制指令，这是一些用户不友好的接口
   而在硬件之上的操作系统则提供了一系列用户友好的交互接口
   > 封装思想：操作系统把一些丑陋的硬件功能封装成简单易用的服务，使用户能更方便的使用计算机。用户无需关心底层硬件的原理，只需对操作系统发出命令即可。
3. 是最接近硬件的一层软件。
   操作系统本身需要实现对硬件机器的扩展。对于一个裸机，一般需要安装操作系统扩展其功能。通常把覆盖率软件的机器成为**扩充机器**，又称之为虚拟机。
   操作系统对硬件机器进行扩展，将CPU、内存、磁盘、显示器、键盘等合理的组织起来，让彼此能够相互配合，实现更多复杂的功能。

### 操作系统的四个基本特征
操作系统的基本特征为：并发、共享、虚拟、异步。其中**并发**和**共享**是两个最基本的特征，两者互为存在条件。
1. 并发：指两个时间在同一时间间隔内发生，这些时间宏观是同时发生额，但是微观上是交替发生的。
   并行：指两个或多个事件在同一时刻同时发生
   **操作系统的并发性**指计算机系统中“同时”运行着多个程序，这些程序宏观上看是同时运行的，而微观上看是交替运行的。
   操作系统就是伴随着“多道程序技术”而出现的，因此，操作系统和程序并发是一起诞生的。
   - **注意**：
     - 单核CPU同一时刻只能执行一个程序，各个程序只能并发的执行
     - 多核CPU同一时刻可以同时执行多个程序，多个程序可以并发地执行
2. 共享：即资源共享，是指系统中的资源可供多个并发执行的进程共同使用。
   - 其中存在两种资源共享模式：
     - 互斥共享：系统中的某些资源，虽然可以提供给多个进程使用，但是一个时间段内只允许一个进程访问该资源
     - 系统中的某些资源，允许一个时间段内由多个进程“同时”对他们进行访问。其中的“同时”是宏观意义上的，而在微观上，这些进程可能是交替地对该资源进行访问的（即分时共享）
3. 虚拟：指吧一个物理上的实体变为若干个逻辑上的对应物。物理实体（前者）是实际存在的，而在逻辑上对应物（后者）是用户实际感受到的
    - 空分复用技术（如虚拟存储技术）。
    - 时分复用技术（如虚拟处理器）。
    - 显然，如果失去了并发性，则一个时间段内系统中只需运行一道程序，那么就失去了实现虚拟性的意义了。因此，没有并发性，就谈不上虚拟性。
4. 异步：指在多道程序环境下，允许多个程序并发执行，但是由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可预知的速度向前进，这就是进程的异步性。
   - 如果失去了并发性，即系统只能串行地运行各个程序，那么每个程序的执行会一贯到底。**只有系统拥有了并发性，才有可能导致异步性**

### 操作系统的发展与分类
1. 手工操作阶段。纸带输入输出慢，计算速度相对较快。
   - 主要缺点：用户独占全机、人机速度矛盾导致资源利用率极低。 
2. 批处理阶段——单道批处理系统
   引入**脱机输入/输出技术**（用外危机+磁带完成），并由**监督程序**负责控制作业的输入、输出。
   - 主要优点：缓解了一定程度的人机速度矛盾，资源利用率有所提升。
   - 主要缺点：**内存中仅能有一道程序运行**，只有该程序运行阶数之后才能调入下一道程序。**CPU有大量时间是在空闲等待I/O完成。**资源利用率依然很低
3. 批处理阶段——多道批处理系统。每次往内存中读入多道程序。操作系统正式诞生，用于支持多道程序并发运行。
   - 主要优点：多道程序并发执行，共享计算机资源。资源利用率大幅提升，CPU和其他资源更能保持“忙碌”状态，系统吞吐量增大。
   - 主要缺点：用户相应时间长，**没有人机交互功能**（用户提交自己的作业后只能等待计算机处理完成，中间不能控制自己的作业。eg：无法调试程序/无法在程序运行过程中输入一些参数）
4. 分时操作系统计算机以**时间片**为单位**轮流为各个用户/作业服务**，各个用户可以通过终端与计算机进行交互。

### 操作系统的运行机制
> “指令”就是处理器（CPU）能识别、执行的最基本的命令
内核是操作系统最核心的部分，也是最接近硬件的部分。

#### 特权指令和非特权指令
对于一些操作系统指令，会对操作系统造成很大的影响，其本身应该只能由管理者进行。这种指令被称为“特权指令”。而对于一些普通的应用程序，一般只能进行“非特权指令”。对于CPU，其设计之初就划分了特权指令和非特权指令，因此CPU执行一条语句前就能识别出其类型。

#### 内核态和用户态
CPU本身有两种状态，内核态和用户态。
处于**用户态**时，说明此时操作系统执行的是应用程序，只能使用**非特权指令**
处于**内核态**时，说明此时操作系统执行的是内核程序，可以使用**特权指令**
> CPU中会存在一个寄存器——**程序状态字寄存器（PSW）**，用于标记当前CPU状态
> 内核态=核心态=管态；用户态=目态
**内核态$->$用户态**：执行一条特权指令————修改PSW为“用户态”
**用户态$->$内核态**：由中断引发，硬件自动完成变化的过程，触发中断信号意味着操作系统将会强制夺回CPU的使用权

### 中断和异常
#### 中断的类型
- 内中断（也称“异常”、“例外”）
  与当前执行的指令**有关**，中断信号来源于CPU**内部**。
  - 如果当前执行的指令是非法的，则会引发一个中断信号
  - 当应用程序需要请求操作系统内核服务时，就会执行**陷入指令**，该指令会引发一个内部中断信号
      > 陷入指令**不是**一条特权指令
- 外中断（也称“中断”）
  与当前执行的指令**无关**，中断信号来源于CPU**外部**
  常见有时钟中断、I/O中断。

#### 中断机制的基本原理
**不同的中断信号，需要使用不同的中断处理程序来处理。**当CPU检测到中断信号后，会根据中断信号的类型去查询“中断向量表”，以此来找到相应的程序在内存中存放的位置。

### 系统调用
“系统调用”是提供给应用程序使用的接口，可以理解为一种可供应用程序调用的特殊函数，**应用程序可以通过系统调用来请求获得操作系统内核的服务**
凡是与**共享资源**有关的操作，都必须通过系统调用的方式向操作系统内核提出服务请求，由操作系统内核代为完成。这样可以保证系统的**稳定性**和**安全性**，防止用户非法操作。
注意：
  1. 陷入指令是在用户态执行的，执行陷入指令之后立刻引发一个内中断，使CPU进入核心态
  2. 发出系统调用请求是在用户态，而对系统调用的相应处理是在核心态下进行的

### 操作系统体系结构
#### 大内核和微内核
- 大内核中，将操作系统的主要功能磨课作为系统内核，运行在核心态。
  - 优点：高性能
  - 缺点：内核代码庞大，结构混乱，难以维护
- 微内核中，只把嘴基本的功能保留在内核
  - 优点：内核功能少，结构清晰，方便维护
  - 缺点：需要频繁的在核心态和用户态之间切换，性能低

#### 分层结构 模块化 外核
##### 分层结构
- 特性思想：内核分多层，每层可单向调用更低一层提供的接口
- 优点：
      1. 便于调试和验证，便于自底向上逐层调试和验证
      2. 易扩充和易维护，各层之间调用接口清晰固定
- 缺点：
      1. 仅可调用相邻低层，难以合理定义各层的边界
      2. 效率低，不可跨层调用，系统调用执行时间长

##### 模块化
- 特性思想：
      1. 将内核划分为多个模块，各个模块之间相互协作。
      2. 内核 = 主模块 +可加载内核模块
      3. 主模块：只负责核心功能，如进程调度、内存管理
      4. 可加载内核模块：可以动态加载新模块到内核，而无需重新编译整个内核
- 优点：
      1. 模块之间逻辑清晰，便于维护，确定模块间的接口后即可多模块同时开发
      2. 支持动态加载新的内核模块（如安装驱动设备程序、安装新文件系统到内核），增强OS适应性
      3.  任何模块都可以直接调用其他模块，无需采用消息进行通信，效率高
- 缺点：
      1. 模块之间的接口定位未必合理实用
      2. 模块之间相互依赖，更难调试和验证

##### 外核
- 特征思想：内核负责进程调度、进程通信等功能，外核负责为用户进程分配未经抽象的硬件资源，且由外核保证资源使安全
- 优点：
      1. 外核可直接给用户进程分配“不虚拟、不抽象”的硬件资源，使用户进程可以灵活的使用硬件资源。
      2. 减少了虚拟硬件资源的映射层，提升效率
- 缺点：
      1. 降低了系统的一致性
      2. 使系统变得复杂

### 操作系统的引导
直接上图
![操作系统初始化](/img/操作系统(1)/操作系统引导.png) 

### 虚拟机
虚拟机：使用虚拟化技术，将一台物理机器虚拟化为多台虚拟机器，每个虚拟机都可以独立运行一个操作系统
同意术语：虚拟机管理程序/虚拟机监控程序/Virtual Machine Monitor/Hypervisor
![虚拟机](/img/操作系统(1)/虚拟机.png)


| 区别               | 第一类VMM                                                                                    | 第二类VMM                                                                                                                              |
| ------------------ | -------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| 对物理资源的控制权 | 直接运行在硬件之上，能够直接控制和分配物理资源                                               | 运行在Host OS之上，依赖于Host OS 为其分配物理资源                    |
| 资源分配方式       | 在安装GuestOS时，VMM要在存储上自行分配存储空间，类似于外核的分配方式，分配未经抽象的物理硬件 | Guest OS拥有自己的虚拟硬盘，该盘实际上是 Host OS系统中的一个大文件，Guest OS分配到的内存是虚拟内存                                      |
| 性能               | 性能更好                                                                                     | 性能更差，需要Host OS作为中介                                                                                                          |
| 可支持虚拟机数量   | 更多，不需要Host OS竞争资源，相同的硬件资源可以支持更多的虚拟机                              | 更少，Host OS本身需要                                                                                                                  | 使用物理资源，Host OS上运行其他进程也需要物理资源 |
| 虚拟机的可迁移性   | 更差                                                                                         | 更好，只需导出虚拟机镜像文件即可迁移到另一台Host OS上，商业用途广泛                                                                    |
| 运行模式           | 第一类VMM运行在最高特权(ring 0)可以自行最高特权指令                                          | 第二类VMM部分运行在用户态，部分运行在用户态，部分运行在内核态。Guest OS 发出的系统调用部分会被VMM截获，并转化为VMM对Host OS 的系统调用 |